<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
    xmlns:sec="https://www.thymeleaf.org/thymeleaf-extras-springsecurity5">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta th:name="_csrf.parameterName" th:content="${_csrf.token}" />
    <title>Index</title>
</head>
<style>
.center {
  display: flex;
  justify-content: center;
  align-items: center;
  height: 200px;
  flex-direction: column;
}
div.relative {
  position: relative;
}

.container {
  position: relative;
  width: 70%;
  margin: 0 auto;
  border-radius: 10px;
  background-color: #f2f2f2;
  padding: 10px 0 40px 0;
} 
.row {

  width: 100%;
  width: 100%;
  padding: 10px 0px 15px 0px;
  margin: auto;
  text-align:center;
}
.input-transparent
{
    background: transparent;
    border: none;
    font-weight:bold;
    font-size:25px;
}

.input
{
    border: none;
    font-weight:bold;
    font-size:25px;
}



</style>
<body>
<!--  
	<input type="text" name="yourName" id="yourName">
    <p>Go to <a id="link" href="hello?name=" onclick="redirectName()">hello.html</a></p>

	<input type="text" name="userId" id="userId">
	<input type="text" name="password" id="password">
    <button type="submit"> Login </button>
-->
	
	<div class="container" th:switch="${#authentication.getPrincipal().getIsActive()}">
	<!-- ${#authorization.expression('hasAuthority(''ACTIVE'')')} -->
		<div th:case="true" >
			<div class="row"  style="font-size: 20px;">
				Welcome Back<b>
				
				<input type="text" th:id="${#authentication.getPrincipal().getUserId()}" 
				th:value="${#authentication.getPrincipal().getDisplayName()}" 
				readonly="readonly" class="input-transparent" ondblclick="doubleClick(this,'displayName')" 
				oninput="this.size = this.value.length" size="3"/>
				(<span th:text ="${#authentication.getPrincipal().getUsername()}">
				Username</span>)
				<!-- (<span th:text ="${#authentication.getPrincipal().getUserId()}">
				id</span>) -->
				
				<span sec:authentication="principal.authorities">
				Role</span><br>
				Email: <span th:text ="${#authentication.getPrincipal().getEmailAddress()}">email</span>
				<br>
				Mobile: <span th:text ="${#authentication.getPrincipal().getMobile()}">mobile</span>
				</b>
				<br>
				
			</div>
			
			
		
			<div class="row" sec:authorize="hasAnyAuthority('MANAGER', 'ADMIN')">
				<a href="view" >view all users</a><br>
				<a href="register_page">Create Account</a>
			</div>
		</div>
		
		<div th:case="false">
			You are not active
		</div>
		
		
		<div class="row">
			<button type="button" onclick="logout()">Logout</button>
			<form id="logoutForm" method="post" action="perform_logout">
	        	<input type="hidden"  th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
	        </form>
        </div>
		
		
	</div>
</body>
<script type="text/javascript"
        src="webjars/jquery/2.2.4/jquery.min.js"></script>
<script>
	function logout() {
		if(confirm("Sure you want to log out?")){
			var form = document.getElementById('logoutForm');
			form.submit();
		}else{
			return false;
		}
		//location.href = "logout_page";// logout_page : see controller
		
		
	}
	
	function creatAccountButton() {
		location.href = "register_page";
	}
	
	
	function doubleClick(td, col){
		var originalContent=td.value;
		
		if(!td.hasAttribute("readonly")){
			td.setAttribute("readonly",true);
			td.classList.add("input-transparent");
			td.value=originalContent;
		}else{
			td.removeAttribute("readonly");
			td.classList.remove("input-transparent");
			td.classList.add("input");
			td.addEventListener('keypress', function (e) {
			    if (e.key === 'Enter') {
			    	td.classList.remove('input');
			    	td.setAttribute("readonly",true);
					td.classList.add("input-transparent");
			    	var id = td.id
			    	var content = td.value;
			    	var key = col;
			    	
			    	if(content!=originalContent){
				    	var token = $("meta[name='_csrf.parameterName']").attr("content");
						$.ajaxSetup({
					        beforeSend: function(xhr) {
					            xhr.setRequestHeader('X-CSRF-Token', token);
					        }
					    });
					    $.ajax({
							type: "POST",
							url: '/demo1/save/'.concat(id),
							contentType: "application/json",
						    data: JSON.stringify({
						    	[key]: content
						    }),
						    
						    success:function(data) {
								console.log("success " + JSON.stringify(data));
							},
							error:function(data) {
								alert(data.responseText);
								document.getElementById(key+id).value=originalContent; // revert if input is not valid
								
							}
						});
			    	}
				    
			    	console.log(id, key, content);
			    	td.replaceWith(td.cloneNode(true));
			    }
			});
		}
	}
	
	
	/**
	function redirectName() {
		
	    name = document.getElementById("yourName").value;
	    document.getElementById('link').href = "hello?name="+name;
	}**/
	
</script>
</html>