<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
    xmlns:sec="https://www.thymeleaf.org/thymeleaf-extras-springsecurity5">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta th:name="_csrf.parameterName" th:content="${_csrf.token}" />
    
    <title>Hello PostgreSQL</title>
    
</head>
<style>
table {
  border: 1px solid black;
  border-collapse: collapse;
  transition-duration: 0.5s;
  
}
.greyout {
  background-color: lightgrey !important;
  
}
th {
  border: 3px solid black;
  padding: 5px;
}

tr {
  background-color: darkgrey;
}
.highlight {
  background-color: yellow !important;
}

td {
  border: 1px solid black;
  padding: 5px;
}


.input-transparent
{
    background: transparent;
    border: none;
}

.input
{
    border: none;
}




</style>
<body>
    
    <div>
    	<input type="text" placeholder="Search.." >
    
	    <select id="searchBy" onchange="searchBy();">
	    	<option value="id">id</option>
	    	<option value="name">name</option>
	    </select>
    </div>
    
    <div style="float:right;" >Sort by&nbsp;
	    <select id="sortby" onchange="sortBy();">
	    	<option value="id">id</option>
	    	<option value="name">name</option>
	    </select>
    </div>
    <table>
    <thead>
        <tr>
            <th>Name</th>
            <th>ID</th>
            <th>Password</th>
            <th>Email</th>
            <th>Mobile</th>
            <th>Active</th>
            <th>Authority</th>
        </tr>
    </thead>
    <tbody>
    	
    	<tr th:if="${users.empty}">
            <td colspan="3"> No Available </td>
        </tr>
        
        
        <tr th:each="user,iteration : ${users}"  th:id="'row' + ${user.id}"
        	th:class="${user.isActive} ? '' : 'greyout'"
        	th:classappend="${#authentication.getPrincipal().getUserId()} == ${user.id}  ? 'highlight':''"
        	>
        	
            <td>
            	<input type="text" th:value="${user.name}" readonly="readonly" 
            	class="input-transparent"
            	ondblclick="doubleClick(this,'name')"/>
            </td>
            <td>
            	<input type="text" th:id="'id'+${user.id}" th:value="${user.id}" readonly="readonly" 
            	class="input-transparent"
            	ondblclick="doubleClick(this,'id')"/>
            </td>
            <td th:text="${user.password}">Password</td>
            <td >
            	<input type="text" th:id="'email'+${user.id}" th:value="${user.emailAddress}" readonly="readonly" 
            	class="input-transparent"
            	ondblclick="doubleClick(this,'emailAddress')"/>
            </td>
            <td>
            	<input type="text" th:id="'mobile'+${user.id}" th:value="${user.mobile}" readonly="readonly" 
            	class="input-transparent"
            	ondblclick="doubleClick(this,'mobile')"/>
            </td>
            <td >
            	<input type="checkbox"
	            	th:checked="${user.isActive}"
	            	th:id="${user.id}" 
	            	th:disabled="${#authentication.getPrincipal().getUserId()} == ${user.id}"
	            	onchange="showCheckBox(this.id)" 
	            />
            </td>
            
            
            <td th:if="${user.roles.empty}">
            	<select th:id="'role'+${user.id}"
            	 	onchange="selectRole(this, this.id);">
            	 	<option selected="selected" value="xxx">--</option>
			    	<option value="user">USER</option>
			    </select>
            </td>
            <td th:each="role : ${user.roles}">
            	<select th:id="'role'+${user.id}"
            		th:disabled="${#authentication.getPrincipal().getUserId()} == ${user.id}"
            	 	onchange="selectRole(this, this.id);">
			    	<option th:selected="(${role.name}=='USER')" value="user">USER</option>
			    	<option th:selected="(${role.name}=='MANAGER')" value="manager">MANAGER</option>
			    	<option th:selected="(${role.name}=='ADMIN')" value="admin">ADMIN</option>
			    </select>
            </td>
        </tr>
    </tbody>
	</table>

    
</body>
<script type="text/javascript"
        src="/demo1/webjars/jquery/2.2.4/jquery.min.js"></script>
<script type="text/javascript">
	
	$(function(){
		var currentUrl = window.location.href;
		var select = currentUrl.substring(currentUrl.lastIndexOf('/')+1);
		console.log(select);
		if(select=="view"){
			document.getElementById("sortby").value="id";
		}else{
			document.getElementById("sortby").value=select;
		}
		
		
	});
	
	// edit user information other than isactive
	function doubleClick(td, col){
		var originalContent=td.value;
		var otherTds=document.querySelectorAll(".input");
		otherTds.forEach(each => {
			  toString  = new XMLSerializer().serializeToString(each);
			  revert = toString.substring(toString.indexOf("value")+7, 
					  toString.indexOf("class")-2);
			  console.log(revert);
			  each.value=revert;
			  each.setAttribute("readonly",true);
			  each.classList.remove('input');
			  each.classList.add("input-transparent");
		});
		if(!td.hasAttribute("readonly")){
			td.setAttribute("readonly",true);
			td.classList.add("input-transparent");
			td.value=originalContent;
		}else{
			td.removeAttribute("readonly");
			td.classList.remove("input-transparent");
			td.classList.add("input");
			td.addEventListener('keypress', function (e) {
			    if (e.key === 'Enter') {
			    	td.classList.remove('input');
			    	td.setAttribute("readonly",true);
					td.classList.add("input-transparent");
			    	var id = td.parentNode.parentNode.id.replace("row","");
			    	var content = td.value;
			    	var key = col;
			    	
			    	if(content!=originalContent){
				    	var token = $("meta[name='_csrf.parameterName']").attr("content");
						$.ajaxSetup({
					        beforeSend: function(xhr) {
					            xhr.setRequestHeader('X-CSRF-Token', token);
					        }
					    });
					    $.ajax({
							type: "POST",
							url: '/demo1/save/'.concat(id),
							contentType: "application/json",
						    data: JSON.stringify({
						    	[key]: content
						    }),
						    
						    success:function(data) {
								console.log("success " + JSON.stringify(data));
							},
							error:function(data) {
								console.log("error " + JSON.stringify(data));
								if(key=="emailAddress"){
									key="email";
								}
								document.getElementById(key+id).value=originalContent; // revert if input is not valid
								alert(data.responseText);
							}
						});
			    	}
				    
			    	console.log(id, key, content);
			    	td.replaceWith(td.cloneNode(true));
			    }
			});
		}
	}
	
	
	function showCheckBox(id){
		var x = document.getElementById(id).checked;
		var token = $("meta[name='_csrf.parameterName']").attr("content");
		console.log(id,x);
		const obj={
				"isActive": x
			};
		var row = document.getElementById("row"+id);

		if(x){
			row.classList.remove("greyout");
		}else{
			row.classList.add("greyout");
		}
		
		$.ajaxSetup({
	        beforeSend: function(xhr) {
	            xhr.setRequestHeader('X-CSRF-Token', token);
	        }
	    });
    
	    $.ajax({
			type: "POST",
			url: '/demo1/trigger-checkbox/'.concat(id),
			contentType: "application/json",
		    data: JSON.stringify(obj),
		    
		    success:function(data) {
				console.log("success " + data.result);
			},
			error:function(data) {
				console.log("error " + JSON.stringify(data));
			}
			
		});
	}
	
	//changing authority 
	function selectRole(selected, id){
		console.log(selected.value);
		var token = $("meta[name='_csrf.parameterName']").attr("content");
		const obj={
				"role": selected.value.toUpperCase()
			};
		
		$.ajaxSetup({
	        beforeSend: function(xhr) {
	            xhr.setRequestHeader('X-CSRF-Token', token);
	        }
	    });
    
	    $.ajax({
			type: "POST",
			url: '/demo1/change-role/'.concat(id.substring(id.indexOf("role")+4)),
			contentType: "application/json",
		    data: JSON.stringify(obj),
		    
		    success:function(data) {
				console.log("success " + data.result);
			},
			error:function(data) {
				console.log("error " + JSON.stringify(data));
			}
		});
	}
	
	
	
	function sortBy() {
		var x = document.getElementById("sortby").value;
		var token = $("meta[name='_csrf.parameterName']").attr("content");
	
		console.log(x);
        window.location.href="/demo1/sortBy/"+x;
	}
	
</script>
</html>